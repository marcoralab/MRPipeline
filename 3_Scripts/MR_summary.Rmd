---
title: "Untitled"
author: "Shea Andrews"
date: "9/12/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(TwoSampleMR)
library(Hmisc)
library(qvalue)

myspread <- function(df, key, value) {
  # quote key
  keyq <- rlang::enquo(key)
  # break value vector into quotes
  valueq <- rlang::enquo(value)
  s <- rlang::quos(!!valueq)
  df %>% gather(variable, value, !!!s) %>%
    unite(temp, !!keyq, variable) %>%
    spread(temp, value)
}
```

## Read in Summary Datasets
```{r}
mr_res <- read_tsv('~/Dropbox/Research/PostDoc-MSSM/2_MR/Shiny/MR_Results_summary.txt', col_types = list(pt = col_character()))
traits <- read_csv('~/Dropbox/Research/PostDoc-MSSM/2_MR/1_RawData/MRTraits.csv')

exposures <- c('alcc', 'alcd', 'audit', 'bmi', 'cpd', 'dep', 'diab', 'educ', 'fish', 'hdl', 'insom', 'ldl', 'mdd', 'mvpa', 'sleep', 'smkukbb', 'sociso', 'tc', 'trig', 'dbp', 'sbp', 'pp', 'hear')

## LOAD, CSF and Neuropath
outcomes <- c('load', 'aaos', 'ab42', 'ptau', 'tau', 'hipv', 'hipv2015', 'npany', 'nft4', 'hips', 'vbiany')
## LOAD, CSF
#outcomes <- c('load', 'aaos', 'ab42', 'ptau', 'tau', 'hipv', 'hipv2015')

pt <- c('5e-6', '5e-8')

method <- c('IVW', 'Weighted median', 'Weighted mode', 'MR Egger')
```

## Extract Results for key exposures and outcomes 
```{r}

mr_best <- mr_res %>% 
  filter(outcome %in% outcomes) %>% 
  filter(exposure %in% exposures) %>%
  filter(method == 'IVW') %>% 
  group_by(outcome, exposure) %>% 
  filter(MR_PRESSO == ifelse(TRUE %in% MR_PRESSO, TRUE, FALSE)) %>% 
  ungroup()
```

## Calculate Q-values 
p-values tell you the percentage of false positives to expect and take into account the number of tests being run. q-value do not take into account all the tests; they only take into account the tests that are below a threshold that you choose (i.e. tests reporting a q-value of 5% or less). So at a q-value of 5% you, would expect 5% of all significant results to be false positives.
```{r}
qobj <- qvalue(p = mr_best$pval, fdr.level = 0.05)
pi0 <- qobj$pi0 # The proportion of false postive features among all those declared significant

qvales.df <- tibble(pvalues = qobj$pvalues, lfdr = qobj$lfdr, qval = qobj$qvalues, significant = qobj$significant)
mr_best %>% bind_cols(qvales.df) %>% select(-violated.MRPRESSO, -violated.Egger, -violated.Q.Egger, -violated.Q.IVW, -pvalues) %>% arrange(pval) %>% print(n = Inf)

summary(qobj)
hist(qobj)
plot(qobj)
```


```{r}  
res_comb <- mr_best %>% 
  bind_cols(select(qvales.df, qval, significant)) %>% 
  group_by(outcome, exposure) %>% 
  arrange(pval) %>% 
  slice(1) %>% 
  ungroup() %>%
  select(outcome, exposure, pt, MR_PRESSO, nsnp, n_outliers, b, se, pval, qval, significant, violated.MRPRESSO, violated.Egger, violated.Q.Egger, violated.Q.IVW)

res_comb %>% arrange(outcome, pval) %>% 
write_csv('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/0_Summary/res_out.csv')
```

```{r}
res_comb %>% filter(significant == T) %>% 
  

```

## IVW Plots
### LOAD

```{r}
res.plot <- res_comb %>% 
  mutate(b = round(b, 2)) %>% 
  mutate(se = round(se, 2)) %>% 
  mutate(sig = ifelse(pval > 0.0001, round(pval, 4), format(pval, digits = 2, scientific = TRUE))) %>%
  mutate(sig = ifelse(qval < 0.05, paste0(sig, ' â€ '), sig)) %>% 
  left_join(select(traits, code, name), by = c('exposure' = 'code')) %>% 
  mutate(name = ifelse(MR_PRESSO == FALSE, name, paste0(name, '*'))) 

```

```{r , echo=FALSE}
## =========== DW Plots - p models =========== ##
## Plot LOAD results - IVW, all 
res.load <- res.plot %>% 
  filter(outcome == 'load') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.load,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="OR for LOAD per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/load_mr.png', width = 10, height = 5.5, units = 'in')
```

### AAOS
```{r , echo=FALSE}
res.aaos <- res.plot %>% 
  filter(outcome == 'aaos') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.aaos,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="HR for LOAD per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/aaos_mr.png', width = 10, height = 5.5, units = 'in')
```

### Ab42
```{r , echo=FALSE}
res.ab42 <- res.plot %>% 
  filter(outcome == 'ab42') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.ab42,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Ab42 per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ab42_mr.png', width = 10, height = 5.5, units = 'in')
```

### NP any
```{r , echo=FALSE}
res.npany <- res.plot %>% 
  filter(outcome == 'npany') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.npany,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="OR for Neuritic Plaques per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
  ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/NP_mr.png', width = 10, height = 5.5, units = 'in')
```

### Ptau
```{r , echo=FALSE}
res.ptau <- res.plot %>% 
  filter(outcome == 'ptau') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.ptau,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Ptau per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ptau_mr.png', width = 10, height = 5.5, units = 'in')
```

### Tau
```{r , echo=FALSE}
res.tau <- res.plot %>% 
  filter(outcome == 'tau') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.tau,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Tau per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/tau_mr.png', width = 10, height = 5.5, units = 'in')
```

### ntf4
```{r , echo=FALSE}
res.nft4 <- res.plot %>% 
  filter(outcome == 'nft4') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.nft4,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="Estimate for NFT per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/nft_mr.png', width = 10, height = 5.5, units = 'in')
```

### HV 2017
```{r , echo=FALSE}
res.hipv <- res.plot %>% 
  filter(outcome == 'hipv') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hipv,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for HV per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_mr.png', width = 10, height = 5.5, units = 'in')
```

### HV 2015
```{r , echo=FALSE}
res.hipv2015 <- res.plot %>% 
  filter(outcome == 'hipv2015') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hipv2015,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for HV per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv2015_mr.png', width = 10, height = 5.5, units = 'in')
```

### HS 2015
```{r , echo=FALSE}
res.hips<- res.plot %>% 
  filter(outcome == 'hips') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hips,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", exponentiate=T,
                      xlab="Estimate for HS per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/HS_mr.png', width = 10, height = 5.5, units = 'in')
```

### VBI
```{r , echo=FALSE}
res.vbi <- res.plot %>% 
  filter(outcome == 'vbiany') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.vbi,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", exponentiate=T,
                      xlab="Estimate for VBI per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/vbi_mr.png', width = 10, height = 5.5, units = 'in')
```

## Plot load results with all MR models
### LOAD
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("load")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/load_all.png', width = 8.5, height = 5.5, units = 'in')
```

### AAOS
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("aaos")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/aaos_all.png', width = 8.5, height = 5.5, units = 'in')
```

### ab42
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("ab42")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ab42_all.png', width = 8.5, height = 5.5, units = 'in')
```

### NP any
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("npany")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ab42_all.png', width = 8.5, height = 5.5, units = 'in')
```

### ptau
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("ptau")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ptau_all.png', width = 8.5, height = 5.5, units = 'in')
```

### tau
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("tau")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/tau_all.png', width = 8.5, height = 5.5, units = 'in')
```

### NFT4
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("nft4")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/tau_all.png', width = 8.5, height = 5.5, units = 'in')
```

### HV 2017
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("hipv")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_all.png', width = 8.5, height = 5.5, units = 'in')
```

### HV 2015
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("hipv2015")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_all.png', width = 8.5, height = 5.5, units = 'in')
```

### HS
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("hips")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_all.png', width = 8.5, height = 5.5, units = 'in')
```

### VBI
```{r , echo=FALSE}
res_comb %>% 
  filter(outcome == c("vbiany")) %>% 
  rename(term = exposure, estimate = b, std.error = se, p.value = pval, model = method) %>% 
  dwplot(.) + theme_bw() + geom_vline(xintercept = 0, colour = 'grey', linetype = 2) + facet_grid(. ~ pt) + 
  theme(legend.position="bottom") + scale_colour_brewer(palette="Set1") 
#ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_all.png', width = 8.5, height = 5.5, units = 'in')
```


























