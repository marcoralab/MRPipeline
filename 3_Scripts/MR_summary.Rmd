---
title: "Untitled"
author: "Shea Andrews"
date: "9/12/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(TwoSampleMR)
library(Hmisc)
library(qvalue)

myspread <- function(df, key, value) {
  # quote key
  keyq <- rlang::enquo(key)
  # break value vector into quotes
  valueq <- rlang::enquo(value)
  s <- rlang::quos(!!valueq)
  df %>% gather(variable, value, !!!s) %>%
    unite(temp, !!keyq, variable) %>%
    spread(temp, value)
}
```

## Read in Summary Datasets
```{r}
mr_res <- read_tsv('~/Dropbox/Research/PostDoc-MSSM/2_MR/Shiny/MR_Results_summary.txt', col_types = list(pt = col_character()))
traits <- read_csv('~/Dropbox/Research/PostDoc-MSSM/2_MR/1_RawData/MRTraits.csv')

exposures <- c('alcc', 'alcd', 'audit', 'bmi', 'cpd', 'dep', 'diab', 'educ', 'fish', 'hdl', 'insom', 'ldl', 'mdd', 'mvpa', 'sleep', 'smkukbb', 'sociso', 'tc', 'trig', 'dbp', 'sbp', 'pp', 'hear')

## LOAD, CSF and Neuropath
outcomes <- c('load', 'aaos', 'ab42', 'ptau', 'tau', 'hipv', 'hipv2015', 'npany', 'nft4', 'hips', 'vbiany')
## LOAD, CSF
#outcomes <- c('load', 'aaos', 'ab42', 'ptau', 'tau', 'hipv', 'hipv2015')

pt <- c('5e-6', '5e-8')

method <- c('IVW', 'Weighted median', 'Weighted mode', 'MR Egger')
```

## Extract Results for key exposures and outcomes 
```{r}

mr_best <- mr_res %>% 
  filter(outcome %in% outcomes) %>% 
  filter(exposure %in% exposures) %>%
  filter(method == 'IVW') %>% 
  group_by(outcome, exposure) %>% 
  filter(MR_PRESSO == ifelse(TRUE %in% MR_PRESSO, TRUE, FALSE)) %>% 
  ungroup()
```

## Calculate Q-values 
p-values tell you the percentage of false positives to expect and take into account the number of tests being run. q-value do not take into account all the tests; they only take into account the tests that are below a threshold that you choose (i.e. tests reporting a q-value of 5% or less). So at a q-value of 5% you, would expect 5% of all significant results to be false positives.
```{r}
qobj <- qvalue(p = mr_best$pval, fdr.level = 0.05)
pi0 <- qobj$pi0 # The proportion of false postive features among all those declared significant

qvales.df <- tibble(pvalues = qobj$pvalues, lfdr = qobj$lfdr, qval = qobj$qvalues, significant = qobj$significant)
mr_best %>% bind_cols(qvales.df) %>% select(-violated.MRPRESSO, -violated.Egger, -violated.Q.Egger, -violated.Q.IVW, -pvalues) %>% arrange(pval) %>% print(n = Inf)

summary(qobj)
hist(qobj)
plot(qobj)
```


```{r}  
res_comb <- mr_best %>% 
  bind_cols(select(qvales.df, qval, significant)) %>% 
  group_by(outcome, exposure) %>% 
  arrange(pval) %>% 
  slice(1) %>% 
  ungroup() %>%
  select(outcome, exposure, pt, MR_PRESSO, nsnp, n_outliers, b, se, pval, qval, significant, violated.MRPRESSO, violated.Egger, violated.Q.Egger, violated.Q.IVW)

res_comb %>% arrange(outcome, pval) %>% 
write_csv('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/0_Summary/res_out.csv')
```

```{r}
res_comb %>% filter(significant == T) %>% 
  

```

## IVW Plots
### LOAD

```{r}
res.plot <- res_comb %>% 
  mutate(b = round(b, 2)) %>% 
  mutate(se = round(se, 2)) %>% 
  mutate(sig = ifelse(pval > 0.0001, round(pval, 4), format(pval, digits = 2, scientific = TRUE))) %>%
  mutate(sig = ifelse(qval < 0.05, paste0(sig, ' â€ '), sig)) %>% 
  left_join(select(traits, code, name), by = c('exposure' = 'code')) %>% 
  mutate(name = ifelse(MR_PRESSO == FALSE, name, paste0(name, '*'))) 

```

```{r , echo=FALSE}
## =========== DW Plots - p models =========== ##
## Plot LOAD results - IVW, all 
res.load <- res.plot %>% 
  filter(outcome == 'load') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.load,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="OR for LOAD per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/load_mr.png', width = 10, height = 5.5, units = 'in')
```

### AAOS
```{r , echo=FALSE}
res.aaos <- res.plot %>% 
  filter(outcome == 'aaos') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.aaos,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="HR for LOAD per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/aaos_mr.png', width = 10, height = 5.5, units = 'in')
```

### Ab42
```{r , echo=FALSE}
res.ab42 <- res.plot %>% 
  filter(outcome == 'ab42') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.ab42,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Ab42 per unit increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ab42_mr.png', width = 10, height = 5.5, units = 'in')
```

### NP any
```{r , echo=FALSE}
res.npany <- res.plot %>% 
  filter(outcome == 'npany') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.npany,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="OR for Neuritic Plaques per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
  ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/NP_mr.png', width = 10, height = 5.5, units = 'in')
```

### Ptau
```{r , echo=FALSE}
res.ptau <- res.plot %>% 
  filter(outcome == 'ptau') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.ptau,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Ptau per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/ptau_mr.png', width = 10, height = 5.5, units = 'in')
```

### Tau
```{r , echo=FALSE}
res.tau <- res.plot %>% 
  filter(outcome == 'tau') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.tau,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for CSF Tau per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/tau_mr.png', width = 10, height = 5.5, units = 'in')
```

### ntf4
```{r , echo=FALSE}
res.nft4 <- res.plot %>% 
  filter(outcome == 'nft4') %>% 
  arrange(-b) %>%
  as.data.frame()
  
forest_plot_1_to_many(res.nft4,b="b",se="se",
                      exponentiate=T,ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", 
                      xlab="Estimate for NFT per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/nft_mr.png', width = 10, height = 5.5, units = 'in')
```

### HV 2017
```{r , echo=FALSE}
res.hipv <- res.plot %>% 
  filter(outcome == 'hipv') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hipv,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for HV per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv_mr.png', width = 10, height = 5.5, units = 'in')
```

### HV 2015
```{r , echo=FALSE}
res.hipv2015 <- res.plot %>% 
  filter(outcome == 'hipv2015') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hipv2015,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="identity", exponentiate=F,
                      xlab="Estimate for HV per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/hipv2015_mr.png', width = 10, height = 5.5, units = 'in')
```

### HS 2015
```{r , echo=FALSE}
res.hips<- res.plot %>% 
  filter(outcome == 'hips') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.hips,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", exponentiate=T,
                      xlab="Estimate for HS per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/HS_mr.png', width = 10, height = 5.5, units = 'in')
```

### VBI
```{r , echo=FALSE}
res.vbi <- res.plot %>% 
  filter(outcome == 'vbiany') %>% 
  arrange(-b) %>%
  as.data.frame()

forest_plot_1_to_many(res.vbi,b="b",se="se",
                      ao_slc=F, by = NULL,
                      TraitM="name", col1_title="Risk factor", col1_width = 1.75,
                      trans="log2", exponentiate=T,
                      xlab="Estimate for VBI per SD increase in risk factor (95% confidence interval)", 
                      addcols=c('pt', "nsnp", 'sig'), 
                      addcol_widths=c(0.5,0.75,0.75), addcol_titles=c("Pt", "No. SNPs","P-value"))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/vbi_mr.png', width = 10, height = 5.5, units = 'in')
```

## =========== Heat Maps =========== ##


```{r}
traits <- read_csv('~/Dropbox/Research/PostDoc-MSSM/2_MR/1_RawData/MRTraits.csv')
MRsummary <- read_tsv('~/Dropbox/Research/PostDoc-MSSM/2_MR/Shiny/MR_Results_summary.txt')
exposures <- c('alcc', 'alcd', 'audit', 'bmi', 'cpd', 'evrsmk', 'dep', 
               'diab', 'educ', 'fish', 'oilfish', 'hdl', 'insom', 'ldl', 
               'mdd', 'mvpa', 'sleep', 'smkukbb', 'sociso', 
               'tc', 'trig', 'dbp', 'sbp', 'pp', 'hear')

## LOAD, CSF and Neuropath
outcomes <- c('load', 'aaos', 
              'ab42', 'ptau', 'tau', 
              'hipv', 'hipv2015', 
              'npany', 'nft4', 'hips', 'vbiany')

mr_best <- MRsummary %>% 
  filter(outcome %in% outcomes) %>% 
  filter(exposure %in% exposures) %>%
  #filter(exposure %nin% c('fish', 'smkukbb')) %>%
  filter(method == 'IVW') %>% 
  group_by(outcome, exposure) %>% 
  filter(MR_PRESSO == ifelse(TRUE %in% MR_PRESSO, TRUE, FALSE)) %>% 
  ungroup()

qobj <- qvalue(p = mr_best$pval, fdr.level = 0.1)
qvales.df <- tibble(pvalues = qobj$pvalues, lfdr = qobj$lfdr, qval = qobj$qvalues, significant = qobj$significant)

dat <- mr_best %>% 
  bind_cols(select(qvales.df, qval)) %>% 
  group_by(outcome, exposure) %>% 
  arrange(pval) %>% 
  slice(1) %>% 
  ungroup() %>%
  rename(v.MRPRESSO = violated.MRPRESSO, v.Egger = violated.Egger, 
         v.Q.Egger = violated.Q.Egger, v.Q.IVW = violated.Q.IVW) %>%
  select(outcome, exposure, pt, MR_PRESSO, nsnp, n_outliers, b, se, pval, qval, 
         v.MRPRESSO, v.Egger, v.Q.Egger, v.Q.IVW) %>% 
  mutate(Signif = symnum(qval, corr = FALSE, na = FALSE,
                         cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                         symbols = c("***", "**", "*", ".", " "))) %>% 
  mutate(z = b/se) %>% 
  mutate(outcome = fct_relevel(outcome, 'load', 'aaos', 'ab42', 'ptau', 'tau', 'hipv2015', 'hipv', 'hips', 'npany', 'nft4', 'vbiany')) %>% 
  mutate(exposure = fct_relevel(exposure, 'alcc', 'alcd', 'audit', 'bmi', 'cpd', 'smkukbb', 'evrsmk', 'dbp', 'sbp', 'pp', 'diab', 'educ', "fish", "oilfish", "hdl", "ldl", "tc", "trig", "hear", "insom", "sleep", "mvpa", "sociso")) %>% 
  mutate(exposure = fct_recode(exposure, 
                               "Alcohol Consumption" = "alcc", 
                               "Alcohol Dependence" = "alcd", 
                               "AUDIT" = "audit", 'BMI' = "bmi", 
                               "Cigarettes per Day" = "cpd", 
                               "Ever Smoker" = "evrsmk", 
                               "Diastolic Blood Pressure" = "dbp", 
                               "Depressive Symptoms" = "dep", 
                               "Type 2 Diabetes" = "diab", 
                               "Educational Attainment" = "educ", 
                               "Oily Fish Intake" = "fish", 
                               "Oily Fish Intake - Neale" = "oilfish",
                               "High-density lipoproteins" = "hdl", 
                               "Hearing Problems" = "hear", 
                               "Insomnia" = "insom", 
                               "Low-density lipoproteins" = "ldl", 
                               "Major Depressive Disorder" = "mdd", 
                               "Moderate-to-vigorous PA" = "mvpa",
                               "Pulse Pressure" = "pp", 
                               "Systolic Blood Pressure" = "sbp", 
                               "Sleep duration" = "sleep", 
                               "Smoking Status" = "smkukbb", 
                               "Social Isolation" = "sociso", 
                               "Total Cholesterol" = "tc", 
                               "Triglycerides" = "trig")) %>% 
  mutate(outcome = fct_recode(outcome, 
                              "LOAD" = "load", 
                              "AAOS" = "aaos", 
                              "CSF Ab42" = "ab42", 
                              "Hipp. Scle." = "hips", 
                              "Hipp. Vol. - 2017" = "hipv",
                              "Hipp. Vol. - 2015" = "hipv2015", 
                              "NFT" = "nft4", 
                              "NP" = "npany", 
                              "CSF Tau" = "tau", 
                              "CSF Ptau" = "ptau", 
                              "VBI" = "vbiany"))

```

```{r}
dat %>% 
  #mutate(z = ifelse(qval > 0.1, 0, z)) %>% 
  ggplot(., aes(x = exposure, y = outcome, label = Signif, fill = z)) + 
  geom_raster() + 
  geom_text(size = 8) +
  scale_fill_gradient2(low="blue", high="red", mid = "white") + 
  coord_equal() + theme_classic() +
  geom_vline(xintercept=seq(0.5, 23.5, 1),color="white") +
  geom_hline(yintercept=seq(0.5, 11.5, 1),color="white") +
  theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/mrbest_heat.png', width = 9, height = 5.5, units = 'in')

dat %>% 
  ggplot(., aes(x = exposure, y = outcome, size = -log10(qval), label = Signif)) + 
  #ggplot(., aes(x = exposure, y = outcome, label = Signif)) + 
  geom_tile(fill = 'white', alpha = 0.5) + 
  geom_point(aes(color = z), shape = 15) +
  geom_text(size = 8) + 
  coord_equal() + 
  scale_color_gradient2(low="blue", high="red", mid = "white") + 
  geom_vline(xintercept=seq(0.5, 23.5, 1),color="#DEEBF7") +
  geom_hline(yintercept=seq(0.5, 11.5, 1),color="#DEEBF7") +
  theme_classic() + 
  scale_size(range = c(1, 12)) + 
  theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1))
ggsave('~/Dropbox/Research/PostDoc-MSSM/2_MR/4_Output/plots/MR/gns.png', width = 8.5, height = 6, units = 'in')
```























