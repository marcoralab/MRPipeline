---
title: "mr_traitohol_analysis"
author: "Shea Andrews"
date: "25/03/2018"
output:
  html_document:
    df_print: paged
    toc: true
    number_sections: false
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
params:
  trait1_exp.path: 
  trait2_exp.path: 
  trait1.name: 
  trait2.name: 
  trait1.code: 
  trait2.code: 
  out.path: 
  p.threshold: 
  pleitropy: 
---

```{r setup analysis, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)   ## For data wrangling 
library(Hmisc)       ## Contains miscillaneous funtions 
library(TwoSampleMR) ## For conducting MR https://mrcieu.github.io/TwoSampleMR/ 
library(ggplot2)     ## For plotting 
library(MRPRESSO)    ## For pleiotropy analysis  
```

```{r Data Input, include=FALSE, cache=F, echo=FALSE}
## ---- Trait ---- ##
trait1.MRdat <- read_csv(params$trait1_exp.path)
trait2.MRdat <- read_csv(params$trait2_exp.path)

## Data Frame of nsnps and number of iterations 
df.NbD <- data.frame(n = c(10, 50, 100, 500, 1000, 1500, 2000),
       NbDistribution = c(1000, 5000, 10000, 25000, 50000, 75000, 100000))
```


`r if(params$pleitropy == FALSE) {"\\begin{comment}"}`
## Pleiotropy 
Pleiotropy was assesed using Mendelian Randomization Pleiotropy RESidual Sum and Outlier (MR-PRESSO), that allows for the evlation of evaluation of horizontal pleiotropy in a standared MR model. MR-PRESSO performs a global test for detection of horizontal pleiotropy and correction of pleiotropy via outlier removal. 
<br> 

```{r pleiotropy_trait1Exp_trait2Out, echo = F, cache=F, eval = as.logical(params$pleitropy)}
trait1.iter <- df.NbD[which.min(abs(df.NbD$n - nrow(trait1.MRdat))), 2]
trait1_presso <- mr_presso(BetaOutcome = "beta.outcome", 
          BetaExposure = "beta.exposure", 
          SdOutcome = "se.outcome", 
          SdExposure = "se.exposure", 
          OUTLIERtest = TRUE, 
          DISTORTIONtest = TRUE, 
          data = as.data.frame(trait1.MRdat), 
          NbDistribution = trait1.iter,  
          SignifThreshold = 0.05)

if("Global Test" %in% names(trait1_presso$`MR-PRESSO results`) & "Distortion Test" %in% names(trait1_presso$`MR-PRESSO results`)){
  if(is.character(trait1_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`)){
    trait1_snps <- trait1_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`
  } else {
  trait1_snps <- trait1.MRdat[trait1_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`, ]$SNP
  trait1.MRdat <- trait1.MRdat[-trait1_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`,]
  }
}

if("Global Test" %in% names(trait1_presso$`MR-PRESSO results`)){
  trait1_presso.p <- trait1_presso$`MR-PRESSO results`$`Global Test`$Pvalue
} else {
    trait1_presso.p <- trait1_presso$`MR-PRESSO results`$Pvalue
}

```

```{r, eval=as.logical(params$pleitropy), results='asis', include=as.logical(params$pleitropy)}
cat('**Exposure: ', params$trait1.name, '~ Outcome: ', params$trait2.name, ':** The MR-PRESSO global test for pleiotropy was ', if(trait1_presso.p < 0.05){paste('significant', ' (p = ', trait1_presso.p, ').', sep = "")}else{paste('non-significant')}, if(trait1_presso.p < 0.05 & any(ls() %in% "trait1_snps")){paste('The following SNPs were removed due to pleiotropy:', paste(trait1_snps, collapse=", ") )}) 
```
<br> 

```{r pleiotropy_trait2Exp_trait1Out, echo = F, cache=F, eval=as.logical(params$pleitropy)}
trait2.iter <- df.NbD[which.min(abs(df.NbD$n - nrow(trait2.MRdat))), 2]
trait2_presso <- mr_presso(BetaOutcome = "beta.outcome", 
                           BetaExposure = "beta.exposure", 
                           SdOutcome = "se.outcome", 
                           SdExposure = "se.exposure", 
                           OUTLIERtest = TRUE, 
                           DISTORTIONtest = TRUE, 
                           data = as.data.frame(trait2.MRdat), 
                           NbDistribution = trait2.iter,  
                           SignifThreshold = 0.05)

if("Global Test" %in% names(trait2_presso$`MR-PRESSO results`) & "Distortion Test" %in% names(trait2_presso$`MR-PRESSO results`)){
  if(is.character(trait2_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`)){
    trait2_snps <- trait2_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`
  } else {
    trait2_snps <- trait2.MRdat[trait2_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`, ]$SNP
    trait2.MRdat <- trait2.MRdat[-trait2_presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`,]
  }
}

if("Global Test" %in% names(trait2_presso$`MR-PRESSO results`)){
  trait2_presso <- trait2_presso$`MR-PRESSO results`$`Global Test`$Pvalue
} else {
  trait2_presso <- trait2_presso$`MR-PRESSO results`$Pvalue
}

```

```{r, eval=as.logical(params$pleitropy), results='asis', include=as.logical(params$pleitropy)}
cat('**Exposure: ', params$trait2.name, '~ Outcome: ', params$trait1.name, ':** The MR-PRESSO global test for pleiotropy was ', if(trait2_presso < 0.05){paste('significant', ' (p = ', trait2_presso, ').', sep = "")}else{paste('non-significant')}, if(trait2_presso < 0.05 & any(ls() %in% "trait1_snps")){paste('The following SNPs were removed due to pleiotropy:', paste(trait2_snps, collapse=", ") )}) 
```
<br> 


##  Mendelian Randomization Analysis 
To obtain an overall estimate of causal effect, the SNP-exposure (Major Depressive Disorder) and SNP-outcome coefficients (Alzheimerâ€™s disease and Alzheimer's Age of Onset) were combined in 1) a random-effects meta-analysis using an inverse-variance weighted approach (IVW); 2) a Weighted Median approach; 3) and Egger Regression. IVW is equivalent to a weighted regression of the SNP-outcome coefficients on the SNP-exposure coefficients with the intercept constrained to zero. This method assumes that all variants are valid instrumental variables based on the Mendelian randomization assumptions. The causal estimate of the IVW analysis expresses the causal increase in the outcome (or log odds of the outcome for a binary outcome) per unit change in the exposure. Weighted median MR allows for 50% of the instrumental variables to be invalid. MR-Egger regression allows all the instrumental variables to be subject to direct effects (i.e. horizontal pleiotropy), with the intercept representing bias in the causal estimate due to pleiotropy and the slope representing the causal estimate.

### Exposure: `r params$trait1.name` ~ Outcome: `r params$trait2.name`
```{r MR: Trait1Exp_Trait2Out, echo=F, warning=F, message = FALSE}

##  Single snp analysis and meta analysis
single.trait1 <- mr_singlesnp(trait1.MRdat, 
                               single_method = 'mr_wald_ratio', 
                               all_method=c("mr_ivw_fe", "mr_weighted_median", "mr_egger_regression"))

##  MR: IVW analysis
res.trait1 <- mr(trait1.MRdat, method_list = c("mr_ivw_fe", "mr_weighted_median", "mr_egger_regression"))

```
\

Figure 1 illustrates the SNP-specific associations with `r params$trait1.name` versus the association in `r params$trait2.name`.

```{r scatter_plot_trait1, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap= 'Fig. 1: Scatterplot of SNP effects for the association of Trait1 and Trait2'}

##  Scatter Plot
scatter.trait1 <- mr_scatter_plot(res.trait1, trait1.MRdat)
scatter.trait1[[1]] + theme_bw() + theme(legend.position = "bottom", text = element_text(family="Times", size=12)) + 
  guides(col = guide_legend(nrow = 1)) + scale_colour_discrete() +
  labs(x = paste0('SNP effect on ', params$trait2.name), 
       y = paste0('SNP effect on ', params$trait1.name))  

```
\

Figure 2 and Table 1 shows the SNP-specific effects and overall IVW, weighted median and Egger regression causal estimates of genetically predicted `r params$trait1.name` on `r params$trait2.name`.

```{r forrest_plot_trait1, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap="Fig. 2: Forrest plot of Wald ratios and 95% CIs for SNP-specific and overall IVW, Weighted median and Egger associations"}

##  Forest Plot
forrest.trait1 <- mr_forest_plot(single.trait1)
forrest.trait1[[1]] + theme_classic() + 
  theme(legend.position = "none", text = element_text(family="Times", size=12)) + 
  labs(x = paste0('MR effect size for \n', params$trait1.name, ' on ', params$trait2.name))

```
<br>

**Table 1:** MR estimates for `r params$trait1.name`, on `r params$trait2.name`
```{r MR trait1 table, echo=F}
as.data.frame(single.trait1 %>% 
  select(SNP, b, se, p)) 

```
\

Figure 3 shows a funnel plot to detect pleiotropy and Table 2 show the results of Cochrans Q heterogeneity test to assess for the presence of pleiotropy. 

```{r funnel_plot trait1, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap='Fig. 3: Funnel plot of the MR causal estimates against their precession'}
funnel.trait1 <- mr_funnel_plot(single.trait1)
funnel.trait1[[1]] + theme_bw() + scale_colour_discrete() + 
  theme(legend.position = "bottom", text = element_text(family="Times", size=12))

```
<br>

**Table 2:** Heterogenity tests for `r params$trait1.name` on `r params$trait2.name`
```{r heterogeneity trait1, echo=F}
trait1.het <- mr_heterogeneity(trait1.MRdat, method_list=c("mr_egger_regression", "mr_ivw"))

as.data.frame(trait1.het)

```

**Table 3:** Test for directional pleitropy for `r params$trait1.name` on `r params$trait2.name`
```{r pleitropy trait1, echo=F}
trait1.plei <- mr_pleiotropy_test(trait1.MRdat)

as.data.frame(trait1.plei)

```

### Exposure: `r params$trait2.name` ~ Outcome: `r params$trait1.name`
```{r MR: trait2Exp_trait1Out, echo=F, warning=F, message = FALSE}

##  Single snp analysis and meta analysis
single.trait2 <- mr_singlesnp(trait2.MRdat, 
                              single_method = 'mr_wald_ratio', 
                              all_method=c("mr_ivw_fe", "mr_weighted_median", "mr_egger_regression"))

##  MR: IVW analysis
res.trait2 <- mr(trait2.MRdat, method_list = c("mr_ivw_fe", "mr_weighted_median", "mr_egger_regression"))

```
\

Figure 4 illustrates the SNP-specific associations with `r params$trait2.name` versus the association in `r params$trait1.name`.

```{r scatter_plot trait2, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap= 'Fig. 4: Scatterplot of SNP effects for the association of trait2 and trait1'}

##  Scatter Plot
scatter.trait2 <- mr_scatter_plot(res.trait2, trait2.MRdat)
scatter.trait2[[1]] + theme_bw() + theme(legend.position = "bottom", text = element_text(family="Times", size=12)) + 
  guides(col = guide_legend(nrow = 1)) + scale_colour_discrete() +
  labs(x = paste0('SNP effect on ', params$trait1.name), 
       y = paste0('SNP effect on ', params$trait2.name))  

```
\

Figure 5 and Table 4 shows the SNP-specific effects and overall IVW, weighted median and Egger regression causal estimates of genetically predicted `r params$trait2.name` on `r params$trait1.name`.

```{r forrest_plot trait2, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap="Fig. 5: Forrest plot of Wald ratios and 95% CIs for SNP-specific and overall IVW, Weighted median and Egger associations"}

##  Forest Plot
forrest.trait2 <- mr_forest_plot(single.trait2)
forrest.trait2[[1]] + theme_classic() + 
  theme(legend.position = "none", text = element_text(family="Times", size=12)) + 
  labs(x = paste0('MR effect size for \n', params$trait2.name, ' on ', params$trait1.name))

```
<br>
  
**Table 4:** MR estimates for `r params$trait2.name`, on `r params$trait1.name`
```{r MR trait2 table, echo=F}
as.data.frame(single.trait2 %>% 
                select(SNP, b, se, p)) 

```
\

Figure 6 shows a funnel plot to detect pleiotropy and Table 2 show the results of Cochrans Q heterogeneity test to assess for the presence of pleiotropy. 

```{r funnel_plot trait2, echo=F, message = FALSE, warning=F, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap='Fig. 6: Funnel plot of the MR causal estimates against their precession'}
funnel.trait2 <- mr_funnel_plot(single.trait2)
funnel.trait2[[1]] + theme_bw() + scale_colour_discrete() + 
  theme(legend.position = "bottom", text = element_text(family="Times", size=12))

```
<br>
  
**Table 5:** Heterogenity tests for `r params$trait2.name` and `r params$trait1.name`
```{r heterogeneity trait2, echo=F}
trait2.het <- mr_heterogeneity(trait2.MRdat, method_list=c("mr_egger_regression", "mr_ivw"))

as.data.frame(trait2.het %>% select(exposure, outcome, method, Q, Q_df, Q_pval))

```

**Table 6:** Test for directional pleitropy for `r params$trait2.name` and `r params$trait1.name`
```{r pleitropy trait2, echo=F}
trait2.plei <- mr_pleiotropy_test(trait2.MRdat)

as.data.frame(trait2.plei)

```

## MR analysis results
```{r summary_results, echo=F, warning=F}

res_all <- res.trait1 %>% 
  bind_rows(res.trait2) %>% 
  mutate(method = as.character(method)) %>%
  mutate(method = str_replace(method, "Inverse variance weighted \\(fixed effects\\)", 'IVW')) %>% 
  mutate(Signif = symnum(pval, corr = FALSE, na = FALSE, 
                  cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), 
                  symbols = c("***", "**", "*", ".", " "))) %>% 
  select(exposure, outcome, method, nsnp, b, se, pval, Signif)

res_all
```

```{r write_out_MR_results, echo=F}
write_csv(res_all, paste0(params$out.path, params$trait1.code, '/', params$trait1.code, '_', params$trait2.code, '_', params$p.threshold, '_MR_Results.csv'))
write_csv(res_all, paste0(params$out.path, params$trait2.code, '/', params$trait1.code, '_', params$trait2.code, '_', params$p.threshold, '_MR_Results.csv'))
```






















